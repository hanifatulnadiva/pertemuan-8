<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-[#6A7C66] text-white flex flex-col justify-between shadow-2xl z-20">
            <div>
                <div class="h-16 flex items-center justify-center border-b border-[#556556] bg-[#5D7F62]">
                    <h1 class="text-xl font-bold tracking-wider flex items-center">
                        <i class="fas fa-shield-alt mr-2"></i> ADMIN PANEL
                    </h1>
                </div>

                <nav class="mt-6 px-4 space-y-2">
                    <a href="./dashboard.html" class="flex items-center px-4 py-3 text-left rounded-lg bg-[#556556] text-white transition shadow-inner">
                        <i class="fas fa-home w-6"></i> <span class="font-medium">Dashboard Utama</span>
                    </a>
                    <a href="./dashboard-users.html" class="flex items-center px-4 py-3 text-left rounded-lg hover:bg-[#556556] transition opacity-80 hover:opacity-100">
                        <i class="fas fa-users w-6"></i> <span class="font-medium">Daftar Users</span>
                    </a>
                    <a href="./dashboard-apikeys.html" class="flex items-center px-4 py-3 text-left rounded-lg hover:bg-[#556556] transition opacity-80 hover:opacity-100">
                        <i class="fas fa-key w-6"></i> <span class="font-medium">Daftar API Keys</span>
                    </a>
                </nav>
            </div>

            <div class="p-4 border-t border-[#556556] bg-[#5D7F62]">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center border border-white/30">
                        <i class="fas fa-user-tie text-lg"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-xs text-gray-300">Login sebagai:</p>
                        <p id="adminEmailDisplay" class="font-semibold text-sm truncate w-36">...</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full bg-red-500/90 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-semibold transition flex items-center justify-center gap-2 shadow-lg">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-[#F1F3E0] p-8 relative z-10">
            
            <div class="mb-8 border-b border-[#A1BC98]/50 pb-4">
                <h2 class="text-3xl font-bold text-[#546650]">Statistik Sistem</h2>
                <p class="text-sm text-gray-500 mt-1">Ringkasan data penggunaan sistem secara real-time.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500 flex items-center justify-between transition hover:-translate-y-1 hover:shadow-xl">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Total Users</p>
                        <h3 id="countUser" class="text-4xl font-bold text-gray-800 mt-2">...</h3>
                        <a href="./dashboard-users.html" class="text-blue-500 text-xs font-semibold hover:underline mt-3 inline-block">
                            Lihat Detail User &rarr;
                        </a>
                    </div>
                    <div class="p-4 bg-blue-100 rounded-full text-blue-600 shadow-inner">
                        <i class="fas fa-users text-3xl"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-[#D97706] flex items-center justify-between transition hover:-translate-y-1 hover:shadow-xl">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Total API Keys</p>
                        <h3 id="countKey" class="text-4xl font-bold text-gray-800 mt-2">...</h3>
                        <a href="./dashboard-apikeys.html" class="text-[#D97706] text-xs font-semibold hover:underline mt-3 inline-block">
                            Lihat Detail Key &rarr;
                        </a>
                    </div>
                    <div class="p-4 bg-amber-100 rounded-full text-[#D97706] shadow-inner">
                        <i class="fas fa-key text-3xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border border-[#A1BC98]/30">
                <h3 class="text-lg font-bold text-[#546650] mb-6 flex items-center gap-2">
                    <i class="fas fa-chart-bar"></i> Grafik Pertumbuhan Data
                </h3>
                <div class="relative h-80 w-full">
                    <canvas id="myChart"></canvas>
                </div>
            </div>

        </main>
    </div>

<script>
    // 1. AUTHENTICATION & SAFE REDIRECT
    const token = localStorage.getItem('adminToken');
    
    function parseJwt (token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }

    function safeRedirect(path) {
        if (window.location.protocol === 'blob:' || window.location.href.includes('blob:')) {
            console.warn(`[Preview Mode] Redirect ke ${path} dicegah agar tidak error.`);
            return;
        }
        window.location.href = path;
    }

    if (!token) {
        safeRedirect('login.html');
    } else { 
        const u = parseJwt(token); 
        if(u) document.getElementById('adminEmailDisplay').innerText = u.email; 
    }

    function logout() { 
        if(confirm("Yakin ingin logout dari sistem?")) { 
            localStorage.removeItem('adminToken'); 
            safeRedirect('login.html');
        } 
    }

    // 2. LOAD STATS & RENDER CHART
    async function loadStats() {
        try {
            const res = await fetch('http://localhost:3000/api/admin/stats');
            
            if (!res.ok) throw new Error("Gagal mengambil data");

            const data = await res.json();
            animateValue("countUser", 0, data.users, 1000);
            animateValue("countKey", 0, data.apikeys, 1000);
            renderChart(data.users, data.apikeys);

        } catch (err) {
            console.error("Gagal load stats", err);
            document.getElementById('countUser').innerText = "-";
            document.getElementById('countKey').innerText = "-";
        }
    }

    function renderChart(userCount, keyCount) {
        const ctx = document.getElementById('myChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Total Users', 'Total API Keys'],
                datasets: [{
                    label: 'Jumlah Data',
                    data: [userCount, keyCount],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(217, 119, 6, 0.7)'  
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(217, 119, 6, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8,
                    barPercentage: 0.5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }
    loadStats();

</script>
</body>
</html>